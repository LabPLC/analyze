#!/usr/bin/env ruby

require 'trollop'
require File.expand_path(File.join(File.dirname(__FILE__), '..', 'lib', 'analyze'))

opts = Trollop.options do
  opt :path, "Path to Nginx access logs", type: :string, required: true
  opt :sort, "Sorting method (`service` or `hits`)", type: :string, default: 'service'
end


matches = Analyze::API.perform(opts[:path])

by_service = lambda {|a,b| a[0] <=> b[0] }
by_hits    = lambda {|a,b| b[1] <=> a[1] }

sort = opts[:sort] == 'service' ? by_service : by_hits

matches.map(&:flatten).sort(&sort).each do |service,hits|
  str = ""
  str += service.to_s
  str += ": "
  str += hits.to_s
  puts str
end
